#include "Turboc.h"
#include <math.h>

typedef struct Player {
	int x;
	int y;
	int hp;

} Player;

typedef struct Monster {
	int x;
	int y;
	int time;
	int spawn;
} Monster;

typedef struct Star {
	int x;
	int y;
}Star;

int randomCheck(int object) {
	int arr[3] = { 0 , 4 , 5 };
	int i;
	for (i = 0; i < 3; i++) {
		if (arr[i] == object) {
			return 1;
		}
	}
	return 0;
}
int colCheck(int object) { //충돌체크
	int arr[1] = { 0 };
	int i;
	for (i = 0; i < 2; i++) {
		if (arr[i] == object) {
			return 1;
		}
	}
	return 0;
}


int main_window() {										// 시작 화면
	char ch;
	while (1) {
		gotoxy(45, 15);
		printf("게임을 시작하시겠습니까? (y or n)\n");
		if (_kbhit()) {
			ch = _getch();
			if (ch == 0xE0 || ch == 0) {
				_getch();
			}
			else {
				switch (ch) {
				case 'Y':
				case 'y':
					return 1;
					clrscr();
					break;
				case 'N':
				case 'n':
					return 0;
					clrscr();
					break;
				}
			}
		}

	}

}

int main(void)
{
	int map[5][20][30] = {											// 맵
		{
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,9,1,1,1,1,9,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,9,1,1,1,1,0},
		{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,0},
		{0,0,1,0,1,0,1,0,1,0,9,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0},
		{0,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,0},
		{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0},
		{0,1,1,9,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0},
		{0,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,0},
		{0,0,9,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
		},
		{
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{4,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,9,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0},
		{0,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0},
		{0,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,0},
		{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0},
		{0,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0,0,1,0,1,0,1,0},
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
		},
		{
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{4,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,9,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,1,1,9,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,1,0,9,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,9,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
		},
		{
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{4,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,0},
		{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0},
		{0,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,9,1,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,0,9,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,0},
		{0,1,0,1,0,1,0,1,0,1,0,9,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0},
		{0,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
		},
		{
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
		{4,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,9,0,1,0,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,9,1,0},
		{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0},
		{0,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,9,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0},
		{0,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,9,0,1,0,1,0,1,0,1,0,1,0},
		{0,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,0},
		{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0},
		{0,1,9,1,1,1,1,1,1,1,1,1,1,1,1,9,1,1,1,1,1,1,1,1,1,1,1,1,1,0},
		{0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0},
		{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}
		}
	};
	char ch;
	int i, j;
	int time = 0;
	int start = 0;
	int score = 0;
	int key = 0;
	int stage = 0;

	Player player;
	player.x = 2;
	player.y = 1;
	Monster monster;
	monster.x = 8;
	monster.y = 1;
	monster.time = 50;
	monster.spawn = 0;
	Star star;
	star.x = 0;
	star.y = 0;

	star.x = (random(14) + 2) * 2;
	star.y = random(18) + 1;



	while (1) {
		if (main_window() == 1) {
			start = 1;
		}
		else {
			start = 0;
			break;
		}
		while (start) {
			if (_kbhit()) {
				ch = _getch();
				if (ch == 0xE0 || ch == 0) {
					_getch();
				}
				else {
					switch (ch) {
					case 'A':
					case 'a':
						// 캐릭터 왼쪽에 벽이 없으면
						if (!colCheck(map[stage][player.y][player.x / 2 - 1])) {		// 8/2 - 1, 0
							player.x = player.x - 2;
						}
						break;
					case 'D':
					case 'd':
						if (!colCheck(map[stage][player.y][player.x / 2 + 1])) {
							player.x = player.x + 2;
						}
						break;
					case 'W':
					case 'w':
						if (!colCheck(map[stage][player.y - 1][player.x / 2])) {
							player.y = player.y - 1;
						}
						break;
					case 'S':
					case 's':
						if (!colCheck(map[stage][player.y + 1][player.x / 2])) {
							player.y = player.y + 1;
						}
						break;
					}
				}
			}
			//---------과정-----------------------
			if (key >= 1) {
				map[stage][18][29] = 5;
				if (map[stage][player.y][player.x / 2] == 5) {//--------맵이동
					stage = stage + 1;
					player.x = 2;
					player.y = 1;
					monster.spawn = 0;
					key = 0;
					clrscr();
				}
			}
			if (stage > 4) {								// 맵 클리어
				clrscr();
				gotoxy(20, 10);
				printf("게임 클리어!!\n");
				gotoxy(20, 12);
				printf("최종 점수는: %d", score);
				monster.x = 0;
				monster.y = 0;
				player.x = 2;
				player.y = 1;
				monster.spawn = 0;
				key = 0;
				Sleep(1000);
				break;
			}
			if (map[stage][player.y][player.x / 2] == 4) {
				stage = stage - 1;
				player.x = 56;
				player.y = 18;
				key = key + 10;
				clrscr();
			}
			if (map[stage][player.y][player.x / 2] == 9 && monster.spawn == 0) {//-------몹 스폰위치
				monster.spawn = 1;
				monster.x = (random(14) + 2) * 2;
				monster.y = random(19) + 1;
			}
			if (randomCheck(map[stage][monster.y][monster.x / 2]) && monster.spawn == 1) {
				monster.x = (random(14) + 2) * 2;
				monster.y = random(19) + 1;
			}
			if (map[stage][player.y][player.x / 2] == 9 && monster.spawn == 1) {
				monster.time = monster.time + 10;
			}
			if (monster.spawn == 1) {
				time = time + 1;
				monster.time = monster.time - 1;
				if (time % 3 == 0) {				//--------몹 이동
					if (monster.x > player.x) {
						if (!colCheck(map[stage][monster.y][monster.x / 2 - 1]))
							monster.x = monster.x - 2;
					}
					else if (monster.x < player.x) {
						if (!colCheck(map[stage][monster.y][monster.x / 2 + 1]))
							monster.x = monster.x + 2;
					}
					if (monster.y > player.y) {
						if (!colCheck(map[stage][monster.y - 1][monster.x / 2]))
							monster.y = monster.y - 1;
					}
					else if (monster.y < player.y) {
						if (!colCheck(map[stage][monster.y + 1][monster.x / 2]))
							monster.y = monster.y + 1;
					}
				}
				if (player.x == monster.x && player.y == monster.y) {					// 게임 오버
					clrscr();
					gotoxy(20, 10);
					printf("Game Over\n");
					gotoxy(20, 12);
					printf("최종 점수는: %d", score);
					monster.x = 0;
					monster.y = 0;
					player.x = 2;
					player.y = 1;
					monster.spawn = 0;
					key = 0;
					Sleep(1000);
					break;

				}
			}
			if (monster.time == 0) {					//몹 제거
				monster.spawn = 0;
				monster.time = 50;
				monster.x = 0;
				monster.y = 0;
			}
			if (player.x == star.x && player.y == star.y) {					//열쇠 랜덤
				score = score + 1;
				key = key + 1;
				star.x = (random(14) + 2) * 2;
				star.y = random(19) + 1;
			}
			if (randomCheck(map[stage][star.y][star.x / 2])) {				// 열쇠 벽에 생성 막기
				star.x = (random(14) + 2) * 2;
				star.y = random(19) + 1;
			}


			//---------출력-----------------------
			for (i = 0; i < 20; i++) {
				for (j = 0; j < 30; j++) {
					switch (map[stage][i][j]) {
					case 1:
						printf("　");
						break;
					case 0:
						SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 9);
						printf("■");
						break;
					case 3:
						SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 14);
						printf("★");
						break;
					case 5:
						printf("＃");
						break;
					case 4:
						SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 7);
						printf("◇");
						break;
					case 9: //-----------------몹 위치
						printf("　");
						break;
					}
					SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), 7);
					//printf("%d", map[i][j]);

				}
				printf("\n");
			}

			if (monster.spawn == 1) {
				gotoxy(monster.x, monster.y);
				printf("♥");
			}
			gotoxy(star.x, star.y);
			printf("★");
			gotoxy(50, 20);
			printf("점수: %d\n", score);
			gotoxy(50, 21);
			printf("열쇠 수: %d \n", key);
			gotoxy(50, 22);
			printf("스테이지: %d \n", stage + 1);
			if (key >= 1) {
				gotoxy(25, 10);
				printf("문이 열렸습니다.");
			}
			gotoxy(player.x, player.y);
			printf("⊙");

			Sleep(100);	// 0.1초 1000ms = 1s / 100ms = 0.1s
			clrscr();	// clear screen
		}



	}

	return 0;
}
